<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SantaNode NFTs</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
<style>
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(180deg,#800000,#2a0000);color:#fff;text-align:center;min-height:100vh;overflow-x:hidden;}
    header{padding:2rem 1rem;}
    h1{font-size:2.5rem;margin:0; text-shadow: 0 2px 10px rgba(0,0,0,0.5);}
    
    #app{max-width:1100px;margin:2rem auto;padding:1rem;}
    
    /* Bot√£o Principal */
    #connectBtn { background: #ffd700; color: #500000; font-size: 1.2rem; padding: 0.8rem 2rem; border-radius: 50px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
    #connectBtn:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }

    /* Grid das Cartas */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem; padding: 1rem;}
    
    /* Design da Carta com Imagem de Fundo */
    .card{
        border-radius: 15px;
        padding: 1.5rem;
        color: #fff;
        min-height: 380px; /* Altura boa para ver a arte */
        display: flex;
        flex-direction: column;
        justify-content: space-between; 
        position: relative; 
        overflow: hidden;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        transition: transform 0.3s;
    }
    
    .card:hover { transform: translateY(-10px); box-shadow: 0 15px 40px rgba(0,0,0,0.7); border-color: #ffd700; }

    /* Camada escura para leitura do texto */
    .card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.85));
        z-index: 1;
    }

    /* Conte√∫do da Carta (ficam acima da camada escura) */
    .card-content-top, .card-content-bottom {
        position: relative;
        z-index: 2;
    }

    .card h3 { 
        font-size: 1.8rem; 
        margin: 0 0 0.5rem 0; 
        letter-spacing: 1px; 
        text-shadow: 0 2px 4px rgba(0,0,0,1);
    }
    
    .supply-info {
        font-weight: bold; 
        font-size: 0.9em; 
        opacity: 0.9;
        text-shadow: 0 1px 3px rgba(0,0,0,1);
    }

    .price-info { 
        font-size: 1.4rem; 
        font-weight: bold; 
        color: #ffd700; 
        margin: 1rem 0; 
        text-shadow: 0 2px 4px rgba(0,0,0,1);
    }
    
    .price-info small {
        color: #fff;
        font-weight: normal;
        font-size: 0.7em;
    }
    
    /* Bot√£o de Mint dentro da carta */
    .card button {
        background: #fff;
        color: #b30000;
        font-weight: 800;
        border: none;
        padding: 0.8rem;
        width: 100%;
        border-radius: 8px;
        cursor: pointer;
        text-transform: uppercase;
        font-size: 1rem;
        transition: 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        position: relative;
        z-index: 2;
    }
    .card button:hover { background: #ffd700; color: #000; }
    .card button:disabled { background: #555; color: #888; cursor: not-allowed; }

    /* Outros */
    footer{margin-top:3rem;font-size:0.8rem;color:#aaa;}
    .nft-result{margin-top:2rem;}
    .snowflake{position:fixed;top:-10px;color:white;font-size:1.2rem;pointer-events:none;animation:snowfall 10s linear infinite; z-index: 999;}
    @keyframes snowfall{to{transform:translateY(110vh);opacity:0;}}
    .desc{margin-top:1rem;font-size:0.9rem;color:#ffd;}
    .desc a{color:#fff;text-decoration:underline;}
</style>
</head>
<body>

<header>
    <h1>üéÖ SantaNode NFTs</h1>
    <p>Mint festive NFTs and burn $NODE to spread Christmas cheer!</p>
</header>

<div id="app">
  <button id="connectBtn">Connect Wallet</button>
  <div id="address" style="margin-top:10px;color:#ffd700;"></div>
  
  <p id="burnedCounter" style="font-size:1.2rem; margin: 20px 0;">üî• Total $NODE Burned: <strong>Loading...</strong></p>
  
  <div class="grid" id="rarityGrid"></div>
  
  <p class="desc">üí° 50% of every NFT purchase is permanently burned:<br>
  <a href="https://etherscan.io/address/0x2080FeE444118AFCe30fCb749802C18c0a980dB7" target="_blank">0x2080FeE444118AFCe30fCb749802C18c0a980dB7</a></p>
  
  <div class="nft-result" id="result"></div>
</div>

<footer>Powered by NodeOps ‚Ä¢ Built with ‚ù§Ô∏è using Ethereum & $NODE</footer>

<script>
    // --- CONFIGURA√á√ÉO ---
    // Seu contrato implantado:
    const CONTRACT_ADDRESS = "0x43B7074714dBbCc50c80238E0Aab849c33A6A075"; 
    
    // Contrato do Token $NODE
    const TOKEN_ADDRESS = "0x2F714d7b9A035d4ce24af8d9b6091c07E37f43Fb"; 
    
    const nodePriceUSD = 0.02281; // Pre√ßo base para display

    // --- ABIs ---
    const ABI_NFT = [
        "function mintNFT(uint8 rarity) external",
        "function getRarityStats(uint8 rarity) view returns (uint256 price, uint256 maxSupply, uint256 minted)"
    ];

    const ABI_TOKEN = [
        "function approve(address spender, uint256 amount) public returns (bool)",
        "function allowance(address owner, address spender) public view returns (uint256)"
    ];

    // Dados das cartas com os LINKS DO IPFS PARA AS IMAGENS
    const rarities = [
        {
            name: 'Common', 
            id: 0,
            image: 'https://gateway.pinata.cloud/ipfs/bafybeigguaozw7yejcy3todm2bworaxsathi6fvdeqavx3nmv7ly5lkc5m'
        },
        {
            name: 'Uncommon', 
            id: 1,
            image: 'https://gateway.pinata.cloud/ipfs/bafybeig4cpdi7jb4lhql42dta4yac5lggxcrdbzxag3yg6hon7a7gwudua'
        },
        {
            name: 'Rare', 
            id: 2,
            image: 'https://gateway.pinata.cloud/ipfs/bafybeihtojj22cqiltvp4anm5hp5fn5rptimbqq3i3cdwh6aubcjs223ha'
        },
        {
            name: 'Epic', 
            id: 3,
            image: 'https://gateway.pinata.cloud/ipfs/bafybeiccloja4qw6bbq5uwezfppcgmc5deuij5jrolie4n2wpac6xw3hra'
        },
        {
            name: 'Legendary', 
            id: 4,
            image: 'https://gateway.pinata.cloud/ipfs/bafybeiefw5k3yno6f7djb2kg3wgmou33vihuatjo7cq3vk4g4pykmjuwju'
        },
        {
            name: 'Mythic', 
            id: 5,
            image: 'https://gateway.pinata.cloud/ipfs/bafybeib7hi6dcbmmbhwwu2v4oa22daqdfgifmhlnkauyl6elw2fq7l57pi'
        }
    ];

    let provider, signer, nftContract, tokenContract;

    // Inicializa o Grid Vazio com IMAGENS DE FUNDO
    function initLayout() {
        const grid = document.getElementById('rarityGrid');
        grid.innerHTML = ''; 
        rarities.forEach((r, i) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = `card-${i}`;
            
            // Define a imagem do IPFS como fundo
            card.style.backgroundImage = `url('${r.image}')`;
            
            card.innerHTML = `
                <div class="card-content-top">
                    <h3>${r.name}</h3>
                    <div class="supply-info">Loading...</div>
                </div>
                <div class="card-content-bottom">
                    <div class="price-info">--- $NODE</div>
                    <button onclick="mintReal(${i})" id="btn-${i}" disabled>Connect Wallet</button>
                </div>`;
            grid.appendChild(card);
        });
    }

    // Conectar Carteira
    document.getElementById('connectBtn').onclick = async () => {
        if (window.ethereum) {
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                
                document.getElementById('address').innerText = `Connected: ${address.slice(0,6)}...${address.slice(-4)}`;
                document.getElementById('connectBtn').style.display = 'none';

                nftContract = new ethers.Contract(CONTRACT_ADDRESS, ABI_NFT, signer);
                tokenContract = new ethers.Contract(TOKEN_ADDRESS, ABI_TOKEN, signer);

                // Ativa bot√µes e carrega dados
                updateContractData();
                
            } catch (e) {
                console.error(e);
                alert("Connection failed: " + e.message);
            }
        } else {
            alert("Please install MetaMask or Rabby!");
        }
    };

    // Ler dados do Blockchain
    async function updateContractData() {
        let totalBurned = 0;
        
        for (let i = 0; i < rarities.length; i++) {
            try {
                const stats = await nftContract.getRarityStats(i); 
                // stats[0]=price, stats[1]=max, stats[2]=minted
                
                const price = ethers.formatEther(stats[0]);
                const max = Number(stats[1]);
                const minted = Number(stats[2]);
                
                const card = document.getElementById(`card-${i}`);
                card.querySelector('.supply-info').innerText = `${minted} / ${max} minted`;
                card.querySelector('.price-info').innerHTML = `${parseInt(price)} $NODE<br><small>‚âà $${(price * nodePriceUSD).toFixed(2)}</small>`;
                
                const btn = document.getElementById(`btn-${i}`);
                if (minted >= max) {
                    btn.innerText = "Sold Out";
                    btn.disabled = true;
                } else {
                    btn.innerText = `Mint ${rarities[i].name}`;
                    btn.disabled = false;
                }
                
                totalBurned += (minted * parseFloat(price) / 2);

            } catch (err) {
                console.log("Error fetching rarity " + i, err);
            }
        }
        document.querySelector('#burnedCounter strong').innerText = totalBurned.toLocaleString() + " $NODE";
    }

    // Fun√ß√£o Principal de Mint
    window.mintReal = async (rarityId) => {
        if (!nftContract) return;

        const btn = document.getElementById(`btn-${rarityId}`);
        const originalText = btn.innerText;
        
        try {
            // 1. Pegar Pre√ßo Atual
            const stats = await nftContract.getRarityStats(rarityId);
            const priceWei = stats[0];

            // 2. Verificar Aprova√ß√£o (Allowance)
            btn.innerText = "Checking...";
            const userAddress = await signer.getAddress();
            const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);

            if (allowance < priceWei) {
                btn.innerText = "Approving...";
                const txApprove = await tokenContract.approve(CONTRACT_ADDRESS, priceWei);
                await txApprove.wait(); // Espera confirma√ß√£o
            }

            // 3. Executar Mint
            btn.innerText = "Minting...";
            const txMint = await nftContract.mintNFT(rarityId); 
            await txMint.wait(); // Espera confirma√ß√£o

            alert("Mint Successful! Merry Christmas! üéÖ");
            updateContractData();
            
            document.getElementById('result').innerHTML = `
                <div style='margin:2rem auto;max-width:400px;border-radius:10px;padding:1rem;background:#fff;color:#000;border: 4px solid #ffd700;box-shadow: 0 0 20px #ffd700;'>
                    <h2>üéâ Congratulations!</h2>
                    <p>You successfully minted a <strong>${rarities[rarityId].name}</strong> NFT.</p>
                </div>`;
            document.getElementById('result').scrollIntoView({behavior: "smooth"});

        } catch (error) {
            console.error(error);
            let msg = error.reason || error.message || "Unknown error";
            
            if(msg.includes("Sold out")) msg = "Sold Out!";
            if(msg.includes("insufficient allowance")) msg = "Please approve the token transaction.";
            if(msg.includes("user rejected")) msg = "Transaction cancelled.";
            
            alert("Error: " + msg);
        } finally {
            if(btn.innerText !== "Sold Out") {
                const currentStats = await nftContract.getRarityStats(rarityId).catch(()=>[0,0,1000]); 
                if (Number(currentStats[2]) < Number(currentStats[1])) {
                    btn.innerText = `Mint ${rarities[rarityId].name}`;
                    btn.disabled = false;
                }
            }
        }
    };

    // Efeito de neve
    function snow(){const s=document.createElement('div');s.className='snowflake';s.textContent='‚ùÑÔ∏è';s.style.left=Math.random()*100+'vw';s.style.fontSize=Math.random()*12+10+'px';document.body.appendChild(s);setTimeout(()=>s.remove(),10000);}
    setInterval(snow,300);
    
    // Inicia layout
    initLayout();
</script>
</body>
</html>



